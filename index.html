<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dusty Nova</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background-color: #000;
        color: #f9fafb;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
      }

      figure {
        margin: 0;
        height: 100vh;
      }

      .monitor-station {
        --screen-top: 18%;
        --screen-left: 11%;
        --screen-right: 11%;
        --screen-bottom: 43%;
        position: fixed;
        bottom: 0;
        left: 0;
        width: min(27rem, 42vw);
        max-width: 440px;
        pointer-events: none;
        user-select: none;
        transform: translate(-10%, 13%);
      }

      .auth-actions {
        position: absolute;
        top: var(--screen-top);
        left: var(--screen-left);
        right: var(--screen-right);
        bottom: var(--screen-bottom);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        pointer-events: none;
        opacity: 1;
        transition: opacity 300ms ease;
      }

      .auth-actions__content {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: clamp(1.65rem, 3vw, 2.35rem) clamp(1.4rem, 2.4vw, 2rem);
        border-radius: 1.35rem;
        background: rgba(3, 7, 18, 0.82);
        border: 1px solid rgba(52, 211, 153, 0.35);
        box-shadow: 0 24px 48px rgba(6, 15, 11, 0.6);
        overflow: hidden;
        isolation: isolate;
        pointer-events: auto;
        transition: transform 300ms ease, opacity 300ms ease;
        backdrop-filter: blur(3px);
      }

      .auth-actions__content::before {
        content: "";
        position: absolute;
        inset: -15% -10% -15%;
        background-image:
          linear-gradient(180deg, rgba(1, 11, 8, 0.92) 0%, rgba(1, 24, 18, 0.78) 100%),
          url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27160%27%20height%3D%27320%27%3E%0A%20%20%3Crect%20width%3D%27160%27%20height%3D%27320%27%20fill%3D%27none%27%2F%3E%0A%20%20%3Cg%20fill%3D%27%2316f89d%27%20font-family%3D%27monospace%27%20font-size%3D%2718%27%20opacity%3D%270.45%27%3E%0A%20%20%20%20%3Ctext%20x%3D%274%27%20y%3D%2720%27%3E1010010110010110%3C%2Ftext%3E%0A%20%20%20%20%3Ctext%20x%3D%2720%27%20y%3D%2752%27%3E0010110100100101%3C%2Ftext%3E%0A%20%20%20%20%3Ctext%20x%3D%278%27%20y%3D%2792%27%3E1101001011010010%3C%2Ftext%3E%0A%20%20%20%20%3Ctext%20x%3D%2730%27%20y%3D%27132%27%3E0101100101100101%3C%2Ftext%3E%0A%20%20%20%20%3Ctext%20x%3D%27-6%27%20y%3D%27172%27%3E1010010110100101%3C%2Ftext%3E%0A%20%20%20%20%3Ctext%20x%3D%2716%27%20y%3D%27212%27%3E0101101001011010%3C%2Ftext%3E%0A%20%20%20%20%3Ctext%20x%3D%272%27%20y%3D%27252%27%3E1001011010010110%3C%2Ftext%3E%0A%20%20%20%20%3Ctext%20x%3D%2726%27%20y%3D%27292%27%3E0010110100101101%3C%2Ftext%3E%0A%20%20%3C%2Fg%3E%0A%3C%2Fsvg%3E");
        background-repeat: no-repeat, repeat;
        background-size: cover, 140px 280px;
        background-position: center, 0 0;
        opacity: 0.95;
        mix-blend-mode: screen;
        animation: matrix-scroll 12s linear infinite;
        pointer-events: none;
        z-index: 0;
      }

      .auth-actions__content::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        border: 1px solid rgba(16, 185, 129, 0.35);
        box-shadow:
          inset 0 0 24px rgba(16, 185, 129, 0.22),
          inset 0 0 4px rgba(59, 130, 246, 0.1);
        pointer-events: none;
        z-index: 1;
      }

      .auth-actions.is-hidden {
        opacity: 0;
      }

      .auth-actions.is-hidden .auth-actions__content {
        opacity: 0;
        transform: translateY(12px);
      }

      .auth-actions__buttons {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
        width: 100%;
        z-index: 2;
      }

      .story-card {
        position: fixed;
        top: 50%;
        right: 3rem;
        transform: translateY(-50%);
        width: min(30rem, 90vw);
        border-radius: 1.25rem;
        background: linear-gradient(
          155deg,
          rgba(15, 23, 42, 0.35) 0%,
          rgba(30, 41, 59, 0.22) 100%
        );
        border: 1px solid rgba(148, 163, 184, 0.12);
        box-shadow: 0 25px 45px rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(12px);
        padding: 2.75rem 2.5rem;
        pointer-events: auto;
      }

      .story-card h2 {
        margin: 0 0 1rem;
        font-size: 1.5rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        color: #e0f2fe;
      }

      .story-card p {
        margin: 0 0 1rem;
        line-height: 1.7;
        color: rgba(226, 232, 240, 0.9);
        font-size: 0.975rem;
      }

      .story-card p:last-child {
        margin-bottom: 0;
      }

      .auth-actions__button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.7rem 0.5rem;
        width: 100%;
        border-radius: 9999px;
        border: 1px solid rgba(34, 197, 94, 0.35);
        color: rgba(226, 252, 239, 0.92);
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        transition: transform 0.2s ease, box-shadow 0.2s ease,
          background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease,
          filter 0.2s ease;
        background-color: rgba(8, 47, 35, 0.6);
        cursor: pointer;
      }

      .auth-actions__button:hover,
      .auth-actions__button:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 16px 30px rgba(4, 120, 87, 0.45);
        background: linear-gradient(135deg, #22c55e, #14b8a6);
        border-color: rgba(45, 212, 191, 0.65);
        color: #022c22;
      }

      .auth-actions__button:focus-visible {
        outline: 2px solid rgba(34, 197, 94, 0.85);
        outline-offset: 3px;
      }

      .auth-actions__button--ghost {
        background-color: rgba(2, 44, 34, 0.35);
        border-color: rgba(45, 212, 191, 0.28);
        color: rgba(209, 250, 229, 0.75);
      }

      .auth-actions__button--ghost:hover,
      .auth-actions__button--ghost:focus-visible {
        background: linear-gradient(135deg, rgba(125, 211, 252, 0.65), rgba(45, 212, 191, 0.65));
        color: #012c1c;
      }

      @keyframes matrix-scroll {
        to {
          background-position: center, 0 280px;
        }
      }

      .monitor-decoration {
        display: block;
        width: 100%;
        height: auto;
        pointer-events: none;
        user-select: none;
      }

      @media (max-width: 1024px) {
        .monitor-station {
          --screen-top: 15%;
          --screen-left: 20%;
          --screen-right: 24%;
          --screen-bottom: 46%;
          width: min(25rem, 52vw);
          max-width: 420px;
          transform: translate(-12%, 15%);
        }

        .story-card {
          top: 3.5rem;
          right: 2rem;
          left: 2rem;
          transform: none;
          width: auto;
        }

        .monitor-decoration {
          width: 100%;
        }
      }

      @media (max-width: 720px) {
        body {
          overflow: auto;
        }

        .monitor-station {
          position: static;
          transform: none;
          width: 100%;
          max-width: none;
          padding: 1.5rem 1.5rem 0;
          display: flex;
          justify-content: center;
        }

        .auth-actions {
          position: static;
          top: auto;
          left: auto;
          right: auto;
          bottom: auto;
          width: min(28rem, 100%);
          justify-content: center;
          margin: 0 auto;
        }

        .auth-actions__content {
          padding: 1.5rem 1.25rem;
          height: auto;
        }

        .story-card {
          position: static;
          margin: 1.5rem;
          width: auto;
          transform: none;
        }

        .wallpaper-frame {
          position: relative;
          height: 60vh;
        }

        .monitor-decoration {
          display: none;
        }
      }

      .wallpaper-frame {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        border-radius: 0;
        overflow: hidden;
        background-color: #000;
        background-size: cover;
        background-position: center;
        isolation: isolate;
      }

      .wallpaper-image {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: inherit;
        opacity: 0;
        transition: opacity 1000ms ease-in-out;
      }

      .wallpaper-image.is-visible {
        opacity: 1;
      }

      noscript {
        position: absolute;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.95rem;
        color: rgba(249, 250, 251, 0.75);
        text-align: center;
        background-color: rgba(0, 0, 0, 0.6);
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
      }
    </style>
  </head>
  <body>
    <figure>
      <div id="wallpaperFrame" class="wallpaper-frame">
        <img
          id="wallpaperImage"
          class="wallpaper-image"
          alt="Wallpaper"
          hidden
        />
      </div>
    </figure>
    <div class="monitor-station">
      <img
        class="monitor-decoration"
        src="images/index/monitor.png"
        alt="Decorative mission monitor"
        width="960"
        height="640"
        loading="lazy"
        decoding="async"
      />
      <aside class="auth-actions" aria-label="Account options">
        <div class="auth-actions__content">
          <div class="auth-actions__buttons" role="group" aria-label="Authentication actions">
            <a class="auth-actions__button" href="pages/login.html">Log in</a>
            <a class="auth-actions__button" href="pages/register.html">Register</a>
            <button class="auth-actions__button auth-actions__button--ghost" type="button">
              Continue as guest
            </button>
          </div>
        </div>
      </aside>
    </div>
    <section class="story-card" aria-labelledby="story-card-title">
      <h2 id="story-card-title">Welcome to Dusty Nova</h2>
      <p>
        In the not-so-distant future, humanity has set its sights on Mars, driven by the promise of
        untapped resources and new frontiers. As a pioneering miner, you are part of the Mars Frontier
        Initiative—an elite team tasked with extracting precious minerals scattered across the
        planet’s harsh, unpredictable terrain.
      </p>
      <p>
        ! Your mission is more than mining. Establish and maintain resource outposts, research advanced
        technologies, and defend key mining sites from rivals and Martian predators. Exploration is
        key—hidden beneath the red dust are rare minerals, ancient ruins, and abandoned settlements
        that hold clues to Mars’ mysterious past.
      </p>
      <p>
        Alliances can turn the tide. Trade with fellow miners, or sabotage competitors to gain an
        edge. Your choices shape the future of Mars colonization. Will you rise as a legendary
        prospector, known for your cunning and courage, or be swallowed by the planet’s unforgiving
        landscape? The red planet awaits—adapt, fight, and survive to claim your fortune.
      </p>
    </section>
    <noscript>This page requires JavaScript to choose a random wallpaper.</noscript>

    <script>
      (function () {
        const imageDirectory = "images/wallpapers/";
        const frameElement = document.getElementById("wallpaperFrame");
        const imageElement = document.getElementById("wallpaperImage");
        const supportedExtensions = [".png", ".jpg", ".jpeg", ".webp", ".gif"];
        const SLIDE_DURATION_MS = 5000;
        const CROSS_FADE_DURATION_MS = 1000;

        const secondaryImageElement = imageElement.cloneNode(false);
        secondaryImageElement.removeAttribute("id");
        secondaryImageElement.removeAttribute("src");
        frameElement.appendChild(secondaryImageElement);

        const imageElements = [imageElement, secondaryImageElement];

        imageElements.forEach((img) => {
          img.hidden = true;
          img.classList.remove("is-visible");
          img.dataset.currentFile = "";
          img.decoding = "async";
          img.loading = "eager";
        });

        imageElement.removeAttribute("src");

        let activeImageElement = null;

        const getNextImageElement = () => {
          if (!activeImageElement) {
            return imageElements[0];
          }
          return imageElements.find((img) => img !== activeImageElement) || imageElements[0];
        };

        const updateAspectRatio = (img) => {
          const { naturalWidth, naturalHeight } = img;
          if (naturalWidth > 0 && naturalHeight > 0) {
            const ratio = naturalWidth / naturalHeight;
            if (Number.isFinite(ratio) && ratio > 0) {
              frameElement.style.setProperty("--wallpaper-aspect", String(ratio));
            }
          }
        };

        const encodePathSegments = (filePath) =>
          filePath
            .split("/")
            .map((segment) => encodeURIComponent(segment))
            .join("/");

        const normaliseFileName = (fileName) => {
          const trimmed = fileName.replace(/^\.\//, "");
          if (trimmed.startsWith(imageDirectory)) {
            return trimmed.slice(imageDirectory.length);
          }
          if (trimmed.startsWith("/")) {
            return trimmed.slice(1);
          }
          return trimmed;
        };

        const setWallpaper = (fileName) => {
          const normalisedFileName = normaliseFileName(fileName);

          if (
            activeImageElement &&
            activeImageElement.dataset.currentFile === normalisedFileName
          ) {
            return Promise.resolve();
          }

          const encodedName = encodePathSegments(normalisedFileName);
          const fullPath = `${imageDirectory}${encodedName}`;
          const nextImageElement = getNextImageElement();

          return new Promise((resolve, reject) => {
            const handleError = () => {
              nextImageElement.removeEventListener("load", handleLoad);
              nextImageElement.hidden = true;
              nextImageElement.classList.remove("is-visible");
              nextImageElement.removeAttribute("src");
              nextImageElement.dataset.currentFile = "";
              reject(new Error(`Unable to load wallpaper: ${normalisedFileName}`));
            };

            const handleLoad = () => {
              nextImageElement.removeEventListener("error", handleError);
              frameElement.style.backgroundImage = `url('${fullPath}')`;

              updateAspectRatio(nextImageElement);

              const previousImageElement = activeImageElement;
              activeImageElement = nextImageElement;
              nextImageElement.dataset.currentFile = normalisedFileName;
              nextImageElement.alt = `Wallpaper: ${normalisedFileName}`;

              const finaliseTransition = () => {
                if (previousImageElement) {
                  previousImageElement.hidden = true;
                  previousImageElement.classList.remove("is-visible");
                  previousImageElement.removeAttribute("src");
                  previousImageElement.dataset.currentFile = "";
                }
                resolve();
              };

              requestAnimationFrame(() => {
                nextImageElement.hidden = false;
                nextImageElement.classList.remove("is-visible");

                requestAnimationFrame(() => {
                  nextImageElement.classList.add("is-visible");

                  if (previousImageElement) {
                    previousImageElement.classList.remove("is-visible");

                    let transitionCompleted = false;
                    let fallbackTimeoutId;

                    const markTransitionComplete = () => {
                      if (transitionCompleted) {
                        return;
                      }
                      transitionCompleted = true;
                      if (fallbackTimeoutId) {
                        window.clearTimeout(fallbackTimeoutId);
                      }
                      finaliseTransition();
                    };

                    previousImageElement.addEventListener(
                      "transitionend",
                      markTransitionComplete,
                      { once: true }
                    );

                    fallbackTimeoutId = window.setTimeout(
                      markTransitionComplete,
                      CROSS_FADE_DURATION_MS + 120
                    );
                  } else {
                    finaliseTransition();
                  }
                });
              });
            };

            if (nextImageElement !== frameElement.lastElementChild) {
              frameElement.appendChild(nextImageElement);
            }

            nextImageElement.classList.remove("is-visible");
            nextImageElement.hidden = true;
            nextImageElement.dataset.currentFile = "";

            nextImageElement.addEventListener("load", handleLoad, { once: true });
            nextImageElement.addEventListener("error", handleError, { once: true });

            nextImageElement.src = fullPath;
          });
        };

        const showError = (message) => {
          frameElement.setAttribute("data-wallpaper-error", message);
          activeImageElement = null;
          imageElements.forEach((img) => {
            img.classList.remove("is-visible");
            img.hidden = true;
            img.removeAttribute("src");
            img.dataset.currentFile = "";
          });
        };

        const isImageFile = (fileName) =>
          supportedExtensions.some((extension) => fileName.toLowerCase().endsWith(extension));

        const parseDirectoryListing = (html) => {
          const parser = new DOMParser();
          const documentFragment = parser.parseFromString(html, "text/html");
          const anchors = Array.from(documentFragment.querySelectorAll("a"));

          return anchors
            .map((anchor) => anchor.getAttribute("href") || "")
            .map((href) => href.split("?")[0])
            .filter((href) => href && !href.startsWith("../"))
            .map((href) => href.replace(/^\.\//, ""))
            .filter((href) => isImageFile(href));
        };

        const dedupe = (items) => Array.from(new Set(items));

        const fetchFromManifest = async () => {
          const manifestUrl = `${imageDirectory}manifest.json`;

          const response = await fetch(manifestUrl, { cache: "no-store" });

          if (!response.ok) {
            if (response.status === 404) {
              return null;
            }
            throw new Error(`Unable to load the wallpapers manifest (${response.status}).`);
          }

          const manifest = await response.json();

          if (!Array.isArray(manifest)) {
            throw new Error("Unexpected wallpapers manifest format.");
          }

          return manifest
            .filter((file) => typeof file === "string")
            .map(normaliseFileName)
            .filter((file) => isImageFile(file));
        };

        const fetchWallpaperFiles = async () => {
          const manifestFiles = await fetchFromManifest();
          if (manifestFiles && manifestFiles.length > 0) {
            return manifestFiles;
          }

          const response = await fetch(imageDirectory, { cache: "no-store" });

          if (!response.ok) {
            throw new Error(`Unable to list wallpapers (${response.status}).`);
          }

          const contentType = response.headers.get("content-type") || "";

          if (contentType.includes("application/json")) {
            const manifest = await response.json();
            if (Array.isArray(manifest)) {
              return manifest
                .filter((file) => typeof file === "string")
                .map(normaliseFileName)
                .filter((file) => isImageFile(file));
            }
            throw new Error("Unexpected wallpapers manifest format.");
          }

          const directoryHtml = await response.text();
          return parseDirectoryListing(directoryHtml).map(normaliseFileName);
        };

        const startSlideshow = (wallpaperFiles) => {
          if (wallpaperFiles.length === 0) {
            showError("No wallpaper images were found in the wallpapers directory.");
            return;
          }

          let index = 0;

          const showNextWallpaper = async () => {
            const currentFile = wallpaperFiles[index];
            try {
              await setWallpaper(currentFile);
            } catch (error) {
              console.error(error);
              showError("Unable to display the wallpaper slideshow right now.");
            } finally {
              index = (index + 1) % wallpaperFiles.length;
              setTimeout(showNextWallpaper, SLIDE_DURATION_MS);
            }
          };

          showNextWallpaper();
        };

        const initialise = async () => {
          try {
            const wallpaperFiles = dedupe(await fetchWallpaperFiles());
            startSlideshow(wallpaperFiles);
          } catch (error) {
            console.error(error);
            showError("Unable to load wallpapers automatically. Please check the server configuration.");
          }
        };

        initialise();

        const authAside = document.querySelector(".auth-actions");
        const guestButton = document.querySelector(
          ".auth-actions__button--ghost"
        );

        if (authAside && guestButton) {
          guestButton.addEventListener("click", () => {
            authAside.classList.add("is-hidden");
            window.setTimeout(() => {
              authAside.hidden = true;
            }, 320);
          });
        }
      })();
    </script>
  </body>
</html>
