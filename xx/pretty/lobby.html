<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warzone 2100 Autohoster — Lobby</title>

  <link rel="stylesheet" href="./css/style.css" />

  <style>
    .wrap { max-width: 1200px; }

    .muted{color:#6b7280}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .controls{
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
      margin:18px 0 12px;
    }
    .controls .spacer{flex:1}

    /* right-side group */
    .rightControls{
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
    }

    .btn2{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .btn2.primary{
      background:#2563eb;
      border-color:#2563eb;
      color:#fff;
    }

    

    a.btn2{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
    }
.pills{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
    .pill{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-size:12px;
    }
    .pill.ok{background:#ecfdf3}
    .pill.bad{background:#fff1f2}

    .card{
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }

    table.lobby{
      width:100% !important;
      border-collapse:separate !important;
      border-spacing:0 !important;
      table-layout:auto !important;
    }
    table.lobby th, table.lobby td{
      padding:10px 10px !important;
      line-height:1.25 !important;
      vertical-align:middle !important;
      white-space:nowrap !important;
      border-bottom:1px solid rgba(0,0,0,.08) !important;
      font-size:14px !important;
    }
    table.lobby th{
      background:#f8fafc !important;
      font-weight:800 !important;
      position:sticky; top:0; z-index:2;
    }
    table.lobby td.wrap{ white-space:normal !important; }
    .right{text-align:right !important;}

    table.lobby tbody tr:nth-child(even) td{background:#fbfdff !important;}
    table.lobby tbody tr:hover td{background:#f3f6ff !important;}

    table.lobby tbody tr.mine td{
      background:#fff7d6 !important;
      font-weight:800 !important;
    }

    .err{color:#b00020;font-weight:800;margin:10px 0}

    @media (max-width: 900px){
      .card{overflow:auto}
      table.lobby{min-width:980px}
    }
  </style>
</head>

<body>
  <header class="topbar">
  <div class="brand"><img class="brand__image" src="./img/ban.png" alt="Warzone 2100 Autohoster" loading="eager" decoding="async" /></div>
  <nav class="nav">
    <a class="navlink" data-nav="home" href="./">Home</a>
    <a class="navlink" data-nav="games" href="./games.html">Games</a>
    <a class="navlink" data-nav="players" href="./players.html">Players</a>
    <a class="navlink" data-nav="lobby" href="./lobby.html">Lobby</a>
    <a class="navlink" data-nav="history" href="./history.html">History</a>
    <a class="navlink" data-nav="leaderboard" href="./top.html">Leaderboard</a>
  </nav>
</header>

  <main class="wrap">
    <section class="page">

      <div class="controls">
        <span id="loaded" class="muted">Loaded 0 games</span>
        <span id="status" class="pill mono">idle</span>

        <span class="spacer"></span>

        <!-- moved to the RIGHT -->
        <div class="rightControls">
          <label class="muted"><input id="hidePrivate" type="checkbox" /> Hide private</label>
          <label class="muted"><input id="hideEmpty" type="checkbox" /> Hide empty</label>
          <a class="btn2" href="./history.html" title="View ended games history">History</a>
          <button id="btnRefresh" class="btn2 primary">Refresh</button>
        </div>
      </div>

      <div class="pills" id="meta"></div>
      <div id="error" class="err"></div>

      <div class="card">
        <table class="lobby">
          <thead>
            <tr>
              <th class="right">GID</th>
              <th class="right">Players</th>
              <th>Game name</th>
              <th>Map name</th>
              <th>Host</th>
              <th class="right">Port</th>
              <th class="right">Version</th>
              <th class="right">Private</th>
              <th class="right">Full</th>
              <th class="right">Modded</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="10" class="muted" style="padding:14px">Loading…</td></tr>
          </tbody>
        </table>
      </div>

    </section>
  </main>

<script>
  // Your servers (highlight + pin)
  const MY_HOSTS = new Set([
    '87.106.148.33', // VPS1
  ]);

  // Hide any game whose NAME contains these words (case-insensitive)
  const HIDE_NAME_CONTAINS = [
    'matchmaking',
  ];

  const el = (id) => document.getElementById(id);
  const els = {
    hidePrivate: el('hidePrivate'),
    hideEmpty: el('hideEmpty'),
    btnRefresh: el('btnRefresh'),
    loaded: el('loaded'),
    status: el('status'),
    meta: el('meta'),
    error: el('error'),
    tbody: el('tbody'),
  };

  let lastData = null;
  let filtered = [];

  function esc(s){
    return String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }
  function yesno(v){ return v ? 'yes' : 'no'; }

  function setStatus(text, kind){
    els.status.textContent = text;
    els.status.className = 'pill mono ' + (kind || '');
  }

  function nameShouldHide(name){
    const n = String(name ?? '').toLowerCase();
    return HIDE_NAME_CONTAINS.some(k => n.includes(k));
  }

  function applyFiltersAndSort(){
    const hidePrivate = els.hidePrivate.checked;
    const hideEmpty = els.hideEmpty.checked;

    let games = Array.isArray(lastData?.games) ? lastData.games.slice() : [];

    // 1) always hide by NAME first (your request)
    games = games.filter(g => !nameShouldHide(g.name));

    // 2) optional UI filters
    games = games.filter(g => {
      if (hidePrivate && g.private) return false;
      if (hideEmpty && (g.curPlayers || 0) === 0) return false;
      return true;
    });

    // Your games first, then most players
    games.sort((a,b) => {
      const ah = String(a.hostIP || a.host || '');
      const bh = String(b.hostIP || b.host || '');
      const am = MY_HOSTS.has(ah) ? 1 : 0;
      const bm = MY_HOSTS.has(bh) ? 1 : 0;
      if (am !== bm) return bm - am;
      return (b.curPlayers||0) - (a.curPlayers||0) || String(a.name||'').localeCompare(String(b.name||''));
    });

    filtered = games;
    render();
  }

  function render(){
    els.loaded.textContent = `Loaded ${filtered.length} games`;

    if (!filtered.length){
      els.tbody.innerHTML = `<tr><td colspan="10" class="muted" style="padding:14px">No games (filters may be hiding them).</td></tr>`;
      return;
    }

    els.tbody.innerHTML = filtered.map(g => {
      const host = String(g.hostIP || g.host || '');
      const isMine = MY_HOSTS.has(host);
      const isFull = (typeof g.isFull === 'boolean') ? g.isFull : ((g.curPlayers ?? 0) >= (g.maxPlayers ?? 9999));
      const players = `${g.curPlayers ?? 0}/${g.maxPlayers ?? '?'}`;

      return `
        <tr class="${isMine ? 'mine' : ''}">
          <td class="right mono">${esc(g.gameID)}</td>
          <td class="right mono">${esc(players)}</td>
          <td class="wrap">${esc(g.name)}</td>
          <td class="wrap">${esc(g.map)}</td>
          <td class="mono">${esc(host)}</td>
          <td class="right mono">${esc(g.port)}</td>
          <td class="right mono">${esc(g.version)}</td>
          <td class="right mono">${yesno(g.private)}</td>
          <td class="right mono">${yesno(isFull)}</td>
          <td class="right mono">${yesno(g.isModded)}</td>
        </tr>
      `;
    }).join('');
  }

  async function load(){
    els.error.textContent = '';
    setStatus('loading…');

    try{
      const lobbyUrl = new URL("../lobby.json", window.location.href).pathname;
      const url = `${lobbyUrl}?ts=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      lastData = await res.json();

      const lobby = lastData?.lobby ?? 'unknown';
      const ts = lastData?.timestamp_utc ?? 'no timestamp';
      const n = lastData?.gamesAvailable ?? (lastData?.games?.length ?? 0);
      const ok = (lastData?.connectionError === false);

      els.meta.innerHTML = `
        <span class="pill mono">${esc(lobby)}</span>
        <span class="pill mono">gamesAvailable=${esc(n)}</span>
        <span class="pill mono">timestamp_utc=${esc(ts)}</span>
        <span class="pill mono ${ok ? 'ok' : 'bad'}">connectionError=${esc(lastData?.connectionError)}</span>
      `;

      setStatus('ok', 'ok');
      applyFiltersAndSort();
    }catch(e){
      setStatus('error', 'bad');
      els.error.textContent = `Failed to load /lobby.json — ${e.message}`;
      els.tbody.innerHTML = `<tr><td colspan="10" class="muted" style="padding:14px">Could not load data.</td></tr>`;
      els.loaded.textContent = `Loaded 0 games`;
    }
  }

  els.btnRefresh.addEventListener('click', load);
  els.hidePrivate.addEventListener('change', () => lastData && applyFiltersAndSort());
  els.hideEmpty.addEventListener('change', () => lastData && applyFiltersAndSort());

  load();
</script>
  <script src="./js/nav-active.js"></script>

<!-- Matomo -->
<script>
  (function() {
    if (/github\.io$/i.test(window.location.hostname)) {
      return;
    }
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  })();
</script>
<!-- End Matomo Code -->

</body>
</html>
