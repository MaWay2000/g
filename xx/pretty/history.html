<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warzone 2100 Autohoster — History</title>

  <link rel="stylesheet" href="./css/style.css" />

  <style>
    .wrap { max-width: 1400px; }

    .muted{color:#6b7280}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .controls{
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
      margin:18px 0 12px;
    }
    .controls .spacer{flex:1}
    .rightControls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn2{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      line-height:1;
    }
    .btn2.primary{
      background:#2563eb;
      border-color:#2563eb;
      color:#fff;
    }
    a.btn2{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
    }

    .pills{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
    .pill{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-size:12px;
    }
    .pill.ok{background:#ecfdf3}
    .pill.bad{background:#fff1f2}

    .card{
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }

    table.history{
      width:100% !important;
      border-collapse:separate !important;
      border-spacing:0 !important;
      table-layout:auto !important;
    }
    table.history th, table.history td{
      padding:10px 10px !important;
      line-height:1.25 !important;
      vertical-align:middle !important;
      white-space:nowrap !important;
      border-bottom:1px solid rgba(0,0,0,.08) !important;
      font-size:14px !important;
    }
    table.history th{
      background:#f8fafc !important;
      font-weight:900 !important;
      position:sticky; top:0; z-index:2;
    }
    table.history td.wrap{ white-space:normal !important; }
    .right{text-align:right !important;}

    table.history tbody tr:nth-child(even) td{background:#fbfdff !important;}
    table.history tbody tr:hover td{background:#f3f6ff !important;}

    table.history tbody tr.mine td{
      background:#fff7d6 !important;
      font-weight:900 !important;
    }

    .err{color:#b00020;font-weight:900;margin:10px 0}

    .mini{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin:8px 0 12px;
    }
    .mini input, .mini select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.15);
      background:#fff;
      font-size:14px;
    }
    .mini label{display:flex; gap:8px; align-items:center}
    .mini .grow{flex:1; min-width: 220px}

    .sectionTitle{
      font-weight:900;
      margin:14px 0 8px;
    }
    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin:10px 0 16px;
    }
    .statsCard{
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .statsHead{
      padding:10px 12px;
      font-weight:900;
      background:#f8fafc;
      border-bottom:1px solid rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .statsBody{ padding:10px 12px; }
    table.stats{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    table.stats th, table.stats td{
      padding:6px 6px;
      border-bottom:1px solid rgba(0,0,0,.08);
      white-space:nowrap;
    }
    table.stats th{ text-align:left; font-weight:900; }
    table.stats td.right{ text-align:right; }
    .tiny{ font-size:12px; color:#6b7280; }
    .warn{ color:#b45309; font-weight:900; }

    @media (max-width: 1000px){
      .statsGrid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 900px){
      .card{overflow:auto}
      table.history{min-width:1100px}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">Warzone 2100 Autohoster</div>
    <nav class="nav">
      <a class="navlink" data-nav="home" href="./">Home</a>
      <a class="navlink" data-nav="games" href="./games.html">Games</a>
      <a class="navlink" data-nav="players" href="./players.html">Players</a>
      <a class="navlink" data-nav="lobby" href="./lobby.html">Lobby</a>
      <a class="navlink" data-nav="history" href="./history.html">History</a>
      <a class="navlink" data-nav="leaderboard" href="./top.html">Leaderboard</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="page">

      <div class="controls">
        <span id="loaded" class="muted">Loaded 0 ended games</span>
        <span id="status" class="pill mono">idle</span>
        <span class="spacer"></span>

        <div class="rightControls">
          <button id="btnRefresh" class="btn2 primary">Refresh</button>
          <button id="btnMore" class="btn2">Load more</button>
          <button id="btnCsv" class="btn2" title="Download currently loaded + filtered rows as CSV">Export CSV</button>
        </div>
      </div>

      <div class="mini">
        <label class="muted">
          Since (UTC)
          <input id="since" type="datetime-local" />
        </label>

        <label class="muted">
          Host IP
          <input id="hostIP" class="mono" placeholder="Warzone2100" />
        </label>

        <label class="muted">
          Page size
          <select id="limit">
            <option value="100">100</option>
            <option value="200" selected>200</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
          </select>
        </label>

        <label class="muted">
          <input id="onlyFull" type="checkbox" />
          Only “was full”
        </label>

        <label class="muted">
          <input id="showDetails" type="checkbox" />
          Show details
        </label>

        <label class="muted grow">
          Search (name/map/host/version)
          <input id="search" class="grow" placeholder="type to filter loaded rows…" />
        </label>
      </div>

      <div class="pills" id="meta"></div>
      <div id="error" class="err"></div>

      <div class="sectionTitle">Hosted counts</div>
      <div class="tiny">
        Uses the server stats endpoint (<span class="mono">/history/api/stats</span>). If you see a warning below, apply the backend patch in the zip.
      </div>

      <div id="statsWarn" class="warn" style="margin:8px 0; display:none"></div>

      <div class="statsGrid">
        <div class="statsCard">
          <div class="statsHead">
            <span>Per day</span>
            <span class="tiny" id="sumDay"></span>
          </div>
          <div class="statsBody">
            <table class="stats">
              <thead>
                <tr><th>Day (UTC)</th><th class="right">Games</th><th class="right">Full</th></tr>
              </thead>
              <tbody id="statsDay"><tr><td colspan="3" class="tiny">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="statsCard">
          <div class="statsHead">
            <span>Per week</span>
            <span class="tiny" id="sumWeek"></span>
          </div>
          <div class="statsBody">
            <table class="stats">
              <thead>
                <tr><th>Week</th><th class="right">Games</th><th class="right">Full</th></tr>
              </thead>
              <tbody id="statsWeek"><tr><td colspan="3" class="tiny">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="statsCard">
          <div class="statsHead">
            <span>Per month</span>
            <span class="tiny" id="sumMonth"></span>
          </div>
          <div class="statsBody">
            <table class="stats">
              <thead>
                <tr><th>Month</th><th class="right">Games</th><th class="right">Full</th></tr>
              </thead>
              <tbody id="statsMonth"><tr><td colspan="3" class="tiny">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <table class="history">
          <thead>
            <tr>
              <th>Ended</th>
              <th>Duration</th>
              <th class="right">Peak</th>
              <th class="right">Max</th>
              <th>Full</th>
              <th>Game</th>
              <th>Map</th>
              <th>Host</th>

              <!-- details (hidden unless Show details) -->
              <th class="right dcol">Port</th>
              <th class="right dcol">Version</th>
              <th class="right dcol">Private</th>
              <th class="right dcol">Modded</th>
              <th class="dcol">First seen</th>
              <th class="dcol">Last seen</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="14" class="muted" style="padding:14px">Loading…</td></tr>
          </tbody>
        </table>
      </div>

    </section>
  </main>

<script>
  // highlight your servers
  const MY_HOSTS = new Set([
    '87.106.148.33',
  ]);

  const API_BASE = '/history/api';

  const el = (id) => document.getElementById(id);
  const els = {
    since: el('since'),
    hostIP: el('hostIP'),
    limit: el('limit'),
    onlyFull: el('onlyFull'),
    showDetails: el('showDetails'),
    search: el('search'),
    btnRefresh: el('btnRefresh'),
    btnMore: el('btnMore'),
    btnCsv: el('btnCsv'),
    loaded: el('loaded'),
    status: el('status'),
    meta: el('meta'),
    error: el('error'),
    tbody: el('tbody'),

    statsWarn: el('statsWarn'),
    statsDay: el('statsDay'),
    statsWeek: el('statsWeek'),
    statsMonth: el('statsMonth'),
    sumDay: el('sumDay'),
    sumWeek: el('sumWeek'),
    sumMonth: el('sumMonth'),
  };

  let allRows = [];
  let offset = 0;

  function esc(s){
    return String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }
  function yesno(v){ return v ? 'yes' : 'no'; }

  function setStatus(text, kind){
    els.status.textContent = text;
    els.status.className = 'pill mono ' + (kind || '');
  }

  function pad2(n){ return String(n).padStart(2,'0'); }

  // datetime-local wants local format "YYYY-MM-DDTHH:MM"
  function toDatetimeLocalValue(d){
    const yyyy = d.getUTCFullYear();
    const mm = pad2(d.getUTCMonth() + 1);
    const dd = pad2(d.getUTCDate());
    const hh = pad2(d.getUTCHours());
    const mi = pad2(d.getUTCMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  // Convert datetime-local (assumed UTC) -> ISO with +00:00
  function sinceToIsoPlus(){
    const v = (els.since.value || '').trim();
    if (!v) return '';
    const isoZ = new Date(v + ':00Z').toISOString();
    return isoZ.replace('Z', '+00:00');
  }

  function buildEndedUrl({limit, offset, hostIP, since}){
    const u = new URL(API_BASE + '/ended', window.location.origin);
    u.searchParams.set('limit', String(limit));
    u.searchParams.set('offset', String(offset));
    if (hostIP) u.searchParams.set('hostIP', hostIP);
    if (since) u.searchParams.set('since', since);
    u.searchParams.set('ts', String(Date.now()));
    return u.pathname + u.search;
  }

  function buildStatsUrl({period, limit, hostIP, since}){
    const u = new URL(API_BASE + '/stats', window.location.origin);
    u.searchParams.set('period', period);
    u.searchParams.set('limit', String(limit));
    if (hostIP) u.searchParams.set('hostIP', hostIP);
    if (since) u.searchParams.set('since', since);
    u.searchParams.set('ts', String(Date.now()));
    return u.pathname + u.search;
  }

  function durationShort(firstSeen, endedAt){
    const a = new Date(firstSeen);
    const b = new Date(endedAt);
    if (!isFinite(a) || !isFinite(b)) return '';
    let sec = Math.max(0, Math.floor((b - a) / 1000));
    const h = Math.floor(sec / 3600); sec -= h * 3600;
    const m = Math.floor(sec / 60); sec -= m * 60;
    if (h) return `${h}h ${m}m`;
    if (m) return `${m}m ${sec}s`;
    return `${sec}s`;
  }

  function tsShort(iso){
    // iso like "2026-01-17T21:07:05+00:00"
    const s = String(iso || '');
    if (s.length < 16) return s;
    return s.replace('T', ' ').slice(0, 16);
  }

  function applyClientFilters(rows){
    const q = (els.search.value || '').trim().toLowerCase();
    const onlyFull = els.onlyFull.checked;

    let out = rows.slice();

    if (onlyFull){
      out = out.filter(r => !!r.wasFull);
    }

    if (q){
      out = out.filter(r => {
        const s = [
          r.name, r.map, r.hostIP, r.version,
          String(r.port ?? ''), String(r.gameID ?? '')
        ].join(' ').toLowerCase();
        return s.includes(q);
      });
    }

    return out;
  }

  function setDetailsVisible(on){
    document.querySelectorAll('.dcol').forEach(th => {
      th.style.display = on ? '' : 'none';
    });
    // also hide/show the matching td cells by column index:
    // We'll do it in render by conditionally emitting cells.
  }

  function render(){
    const view = applyClientFilters(allRows);

    els.loaded.textContent = `Loaded ${view.length} ended games (raw fetched: ${allRows.length}, offset=${offset})`;

    const host = (els.hostIP.value || '').trim();
    const since = sinceToIsoPlus();
    const lim = Number(els.limit.value || 200);

    els.meta.innerHTML = `
      <span class="pill mono">endpoint=${esc(API_BASE + '/ended')}</span>
      <span class="pill mono">limit=${esc(lim)}</span>
      <span class="pill mono">offset=${esc(offset)}</span>
      <span class="pill mono">hostIP=${esc(host || '(any)')}</span>
      <span class="pill mono">since=${esc(since || '(none)')}</span>
      <span class="pill mono">onlyFull=${esc(els.onlyFull.checked)}</span>
      <span class="pill mono">details=${esc(els.showDetails.checked)}</span>
      <span class="pill mono">search=${esc((els.search.value || '').trim() || '(none)')}</span>
    `;

    const showD = els.showDetails.checked;
    setDetailsVisible(showD);

    if (!view.length){
      els.tbody.innerHTML = `<tr><td colspan="14" class="muted" style="padding:14px">No ended games (try widening “since”, clearing filters, or loading more).</td></tr>`;
      return;
    }

    els.tbody.innerHTML = view.map(r => {
      const hostIP = String(r.hostIP || '');
      const isMine = MY_HOSTS.has(hostIP);

      const detailsCells = showD ? `
        <td class="right mono dcol">${esc(r.port ?? '')}</td>
        <td class="right mono dcol">${esc(r.version ?? '')}</td>
        <td class="right mono dcol">${yesno(!!r.lastPrivate)}</td>
        <td class="right mono dcol">${yesno(!!r.lastIsModded)}</td>
        <td class="mono dcol" title="${esc(r.first_seen)}">${esc(tsShort(r.first_seen))}</td>
        <td class="mono dcol" title="${esc(r.last_seen)}">${esc(tsShort(r.last_seen))}</td>
      ` : `
        <td class="dcol" style="display:none"></td>
        <td class="dcol" style="display:none"></td>
        <td class="dcol" style="display:none"></td>
        <td class="dcol" style="display:none"></td>
        <td class="dcol" style="display:none"></td>
        <td class="dcol" style="display:none"></td>
      `;

      return `
        <tr class="${isMine ? 'mine' : ''}">
          <td class="mono" title="${esc(r.ended_at)}">${esc(tsShort(r.ended_at))}</td>
          <td class="mono">${esc(durationShort(r.first_seen, r.ended_at))}</td>
          <td class="right mono">${esc(r.peakPlayers ?? '')}</td>
          <td class="right mono">${esc(r.maxPlayers ?? '')}</td>
          <td class="mono">${yesno(!!r.wasFull)}</td>
          <td class="wrap">${esc(r.name)}</td>
          <td class="wrap">${esc(r.map)}</td>
          <td class="mono">${esc(hostIP)}</td>
          ${detailsCells}
        </tr>
      `;
    }).join('');
  }

  async function fetchPage({reset}){
    els.error.textContent = '';

    const hostIP = (els.hostIP.value || '').trim();
    const limit = Number(els.limit.value || 200);
    const since = sinceToIsoPlus();

    if (reset){
      offset = 0;
      allRows = [];
      els.tbody.innerHTML = `<tr><td colspan="14" class="muted" style="padding:14px">Loading…</td></tr>`;
    }

    setStatus('loading…');

    try{
      const url = buildEndedUrl({limit, offset, hostIP, since});
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();
      if (!Array.isArray(data)) throw new Error('Bad response (expected array)');

      allRows = allRows.concat(data);

      offset += limit;

      setStatus('ok', 'ok');
      render();
    }catch(e){
      setStatus('error', 'bad');
      els.error.textContent = `Failed to load history — ${e.message}`;
      render();
    }
  }

  function csvEscape(v){
    const s = String(v ?? '');
    if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
    return s;
  }

  function exportCsv(){
    const rows = applyClientFilters(allRows);
    if (!rows.length){
      alert('No rows to export (load more or widen filters).');
      return;
    }

    const showD = els.showDetails.checked;

    const header = [
      'ended_at_utc','duration','peakPlayers','maxPlayers','wasFull',
      'name','map','hostIP'
    ];

    if (showD){
      header.push('port','version','private','modded','first_seen_utc','last_seen_utc');
    }

    const lines = [];
    lines.push(header.join(','));

    rows.forEach(r => {
      const dur = durationShort(r.first_seen, r.ended_at);
      const base = [
        r.ended_at, dur, r.peakPlayers, r.maxPlayers, !!r.wasFull,
        r.name, r.map, r.hostIP
      ];

      if (showD){
        base.push(
          r.port ?? '',
          r.version ?? '',
          !!r.lastPrivate,
          !!r.lastIsModded,
          r.first_seen ?? '',
          r.last_seen ?? ''
        );
      }

      lines.push(base.map(csvEscape).join(','));
    });

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);

    const since = sinceToIsoPlus() || 'all';
    const host = (els.hostIP.value || '').trim() || 'any';
    const fname = `wz2100_history_${host}_${since.replace(/[:+]/g,'-')}.csv`;

    const a = document.createElement('a');
    a.href = url;
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  function renderStatsTable(tbodyEl, rows, sumEl){
    if (!rows || !rows.length){
      tbodyEl.innerHTML = `<tr><td colspan="3" class="tiny">No data</td></tr>`;
      sumEl.textContent = '';
      return;
    }
    let sumGames = 0, sumFull = 0;
    tbodyEl.innerHTML = rows.map(r => {
      sumGames += Number(r.games || 0);
      sumFull += Number(r.full_games || 0);
      return `<tr>
        <td class="mono">${esc(r.bucket)}</td>
        <td class="right mono">${esc(r.games)}</td>
        <td class="right mono">${esc(r.full_games)}</td>
      </tr>`;
    }).join('');
    sumEl.textContent = `total ${sumGames} (full ${sumFull})`;
  }

  async function fetchStats(){
    const hostIP = (els.hostIP.value || '').trim();
    const since = sinceToIsoPlus();

    els.statsWarn.style.display = 'none';
    els.statsWarn.textContent = '';

    // limits for buckets
    const limDay = 21;   // ~3 weeks
    const limWeek = 26;  // ~6 months
    const limMonth = 24; // 2 years

    const targets = [
      {period:'day',   limit:limDay,   tbody:els.statsDay,   sum:els.sumDay},
      {period:'week',  limit:limWeek,  tbody:els.statsWeek,  sum:els.sumWeek},
      {period:'month', limit:limMonth, tbody:els.statsMonth, sum:els.sumMonth},
    ];

    for (const t of targets){
      t.tbody.innerHTML = `<tr><td colspan="3" class="tiny">Loading…</td></tr>`;
      t.sum.textContent = '';
      try{
        const url = buildStatsUrl({period:t.period, limit:t.limit, hostIP, since});
        const res = await fetch(url, {cache:'no-store'});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('Bad response');
        renderStatsTable(t.tbody, data, t.sum);
      }catch(e){
        // If endpoint doesn't exist, show one warning and stop spam
        t.tbody.innerHTML = `<tr><td colspan="3" class="tiny">Stats unavailable</td></tr>`;
        if (!els.statsWarn.style.display || els.statsWarn.style.display === 'none'){
          els.statsWarn.style.display = '';
          els.statsWarn.textContent = `Stats endpoint not installed (or error). Apply backend patch: ${e.message}`;
        }
      }
    }
  }

  function setDefaultSince24h(){
    const d = new Date(Date.now() - 24*3600*1000);
    els.since.value = toDatetimeLocalValue(d);
  }

  // Events
  els.btnRefresh.addEventListener('click', () => { fetchPage({reset:true}); fetchStats(); });
  els.btnMore.addEventListener('click', () => fetchPage({reset:false}));
  els.btnCsv.addEventListener('click', exportCsv);

  els.onlyFull.addEventListener('change', render);
  els.showDetails.addEventListener('change', render);
  els.search.addEventListener('input', render);

  els.limit.addEventListener('change', () => { fetchPage({reset:true}); fetchStats(); });
  els.hostIP.addEventListener('change', () => { fetchPage({reset:true}); fetchStats(); });
  els.since.addEventListener('change', () => { fetchPage({reset:true}); fetchStats(); });

  setDefaultSince24h();
  fetchPage({reset:true});
  fetchStats();
</script>

<script src="./js/nav-active.js"></script>

<!-- Matomo -->
<script>
  (function() {
    if (/github\.io$/i.test(window.location.hostname)) {
      return;
    }
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  })();
</script>
<!-- End Matomo Code -->

</body>
</html>
