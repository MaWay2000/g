<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi Timer</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161c; --panel2:#0f1318;
      --text:#e8eef6; --muted:#9fb0c3; --line:#253041;
      --accent:#4aa3ff; --warn:#ffcc66; --danger:#ff5c7a; --ok:#3ddc97;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg, #07080a, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:14px 14px; border:1px solid var(--line); border-radius:16px;
      background:rgba(18,22,28,.75); backdrop-filter: blur(8px);
      position:sticky; top:10px; z-index:10;
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    button, input, select{
      border-radius:12px; border:1px solid var(--line);
      background:var(--panel2); color:var(--text);
      padding:10px 12px; font-size:14px;
      outline:none;
    }
    button{cursor:pointer}
    button.primary{border-color:rgba(74,163,255,.55); background:rgba(74,163,255,.12)}
    button.danger{border-color:rgba(255,92,122,.55); background:rgba(255,92,122,.12)}
    button:active{transform: translateY(1px)}
    input[type="number"]{width:88px}
    input[type="text"]{width:180px}
    .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px; margin-top:14px}
    .card{
      border:1px solid var(--line); border-radius:16px; padding:14px;
      background:rgba(18,22,28,.7); backdrop-filter: blur(8px);
      display:flex; flex-direction:column; gap:10px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .titleRow{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .name{font-weight:650; font-size:15px}
    .meta{font-size:12px;color:var(--muted); margin-top:2px}
    .time{
      font-variant-numeric: tabular-nums;
      font-size:34px; letter-spacing:.5px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--line);
      background:rgba(10,12,15,.5);
    }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      background:rgba(10,12,15,.35);
      white-space:nowrap;
    }
    .badge.running{border-color:rgba(61,220,151,.55); color:#bdf3dd; background:rgba(61,220,151,.10)}
    .badge.done{border-color:rgba(255,92,122,.55); color:#ffd0d9; background:rgba(255,92,122,.10)}
    .smallBtn{padding:8px 10px; font-size:13px}
    .hint{font-size:12px;color:var(--muted); line-height:1.3}
    .footer{
      margin-top:14px; padding:12px 14px; border:1px dashed rgba(37,48,65,.8);
      border-radius:14px; color:var(--muted); font-size:12px;
    }
    .hr{height:1px;background:rgba(37,48,65,.7); margin:8px 0}
    .fileRow input{padding:8px 10px}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Multi Timer</h1>
        <div class="sub">Pizza • Oven • Work • Anything — multiple timers, one screen</div>
      </div>
      <div class="controls">
        <input id="newName" type="text" placeholder="Timer name (e.g. Pizza)" />
        <input id="newMin" type="number" min="0" value="10" title="Minutes" />
        <input id="newSec" type="number" min="0" max="59" value="0" title="Seconds" />
        <button class="primary" id="addBtn">Add timer</button>
        <button id="startAllBtn">Start all</button>
        <button id="pauseAllBtn">Pause all</button>
        <button class="danger" id="clearAllBtn">Clear all</button>
      </div>
    </div>

    <div class="footer">
      <div class="row" style="justify-content:space-between">
        <div>
          <b>Sound:</b> when a timer finishes, it plays a beep (Web Audio).
          <span class="hint">On mobile, you may need to tap once to allow audio.</span>
        </div>
        <div class="row fileRow">
          <label class="badge" for="soundFile">Optional custom sound</label>
          <input id="soundFile" type="file" accept="audio/*" />
          <button id="testSoundBtn" class="smallBtn">Test sound</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="hint">
        Tip: If your phone locks the screen, browsers can throttle timers. For now this is perfect for testing UI/logic — later, the Android wrapper handles “always works” behaviour.
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

<script>
(() => {
  const LS_KEY = "multitimer_v1";
  const grid = document.getElementById("grid");

  const elNewName = document.getElementById("newName");
  const elNewMin  = document.getElementById("newMin");
  const elNewSec  = document.getElementById("newSec");

  const addBtn      = document.getElementById("addBtn");
  const startAllBtn = document.getElementById("startAllBtn");
  const pauseAllBtn = document.getElementById("pauseAllBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");

  const soundFile   = document.getElementById("soundFile");
  const testSoundBtn= document.getElementById("testSoundBtn");

  // ---- Audio (beep fallback + optional custom file) ----
  let audioCtx = null;
  let customSoundUrl = null;
  let customAudio = null;

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }

  function playBeep(){
    ensureAudio();
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.0001;
    o.connect(g);
    g.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.18, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.45);

    o.start(now);
    o.stop(now + 0.5);
  }

  function playCustomOrBeep(){
    ensureAudio();
    if (customAudio){
      customAudio.currentTime = 0;
      customAudio.play().catch(() => playBeep());
    } else {
      playBeep();
    }
  }

  soundFile.addEventListener("change", () => {
    const f = soundFile.files && soundFile.files[0];
    if (!f) return;
    if (customSoundUrl) URL.revokeObjectURL(customSoundUrl);
    customSoundUrl = URL.createObjectURL(f);
    customAudio = new Audio(customSoundUrl);
    customAudio.preload = "auto";
  });

  testSoundBtn.addEventListener("click", () => {
    userGesture();
    playCustomOrBeep();
  });

  // Call once on user action to unlock audio on mobile
  function userGesture(){
    ensureAudio();
  }
  document.addEventListener("click", userGesture, {once:true, passive:true});

  // ---- Timer model ----
  // Each timer:
  // { id, name, totalMs, remainingMs, running, done, endsAtEpochMs|null, createdAt }
  let timers = load();

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(timers));
  }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function format(ms){
    ms = Math.max(0, ms|0);
    const totalSec = Math.floor(ms/1000);
    const h = Math.floor(totalSec/3600);
    const m = Math.floor((totalSec%3600)/60);
    const s = totalSec%60;
    const pad = (x)=> String(x).padStart(2,"0");
    return h>0 ? `${h}:${pad(m)}:${pad(s)}` : `${m}:${pad(s)}`;
  }

  function computeRemaining(t){
    if (!t.running || !t.endsAtEpochMs) return t.remainingMs;
    return t.endsAtEpochMs - Date.now();
  }

  function setRunning(t, running){
    if (t.done) return;
    if (running){
      t.running = true;
      t.endsAtEpochMs = Date.now() + t.remainingMs;
    } else {
      t.running = false;
      t.remainingMs = computeRemaining(t);
      t.endsAtEpochMs = null;
      if (t.remainingMs < 0) t.remainingMs = 0;
    }
  }

  function finishTimer(t){
    t.running = false;
    t.done = true;
    t.remainingMs = 0;
    t.endsAtEpochMs = null;
    save();
    render();
    // A few beeps to make it obvious
    playCustomOrBeep();
    setTimeout(playCustomOrBeep, 650);
    setTimeout(playCustomOrBeep, 1300);
  }

  function addTimer(name, ms){
    const t = {
      id: uid(),
      name: name || "Timer",
      totalMs: ms,
      remainingMs: ms,
      running: false,
      done: false,
      endsAtEpochMs: null,
      createdAt: Date.now()
    };
    timers.unshift(t);
    save();
    render();
  }

  // ---- UI actions ----
  addBtn.addEventListener("click", () => {
    const name = (elNewName.value || "").trim() || "Timer";
    const min = clamp(parseInt(elNewMin.value || "0",10) || 0, 0, 9999);
    const sec = clamp(parseInt(elNewSec.value || "0",10) || 0, 0, 59);
    const ms = (min*60 + sec) * 1000;
    if (ms <= 0) return;
    addTimer(name, ms);
    elNewName.value = "";
  });

  startAllBtn.addEventListener("click", () => {
    userGesture();
    timers.forEach(t => {
      if (!t.done && t.remainingMs > 0) setRunning(t, true);
    });
    save();
    render();
  });

  pauseAllBtn.addEventListener("click", () => {
    timers.forEach(t => setRunning(t, false));
    save();
    render();
  });

  clearAllBtn.addEventListener("click", () => {
    if (!confirm("Clear ALL timers?")) return;
    timers = [];
    save();
    render();
  });

  function bump(t, deltaMs){
    if (t.done) return;
    // pause, modify remaining, restore running state safely
    const wasRunning = t.running;
    setRunning(t, false);
    t.remainingMs = Math.max(0, t.remainingMs + deltaMs);
    t.totalMs = Math.max(t.totalMs, t.remainingMs);
    if (t.remainingMs === 0) t.done = true;
    if (wasRunning && !t.done) setRunning(t, true);
    save();
    render();
  }

  function reset(t){
    t.done = false;
    t.running = false;
    t.remainingMs = t.totalMs;
    t.endsAtEpochMs = null;
    save();
    render();
  }

  function removeTimer(id){
    timers = timers.filter(x => x.id !== id);
    save();
    render();
  }

  function renameTimer(t){
    const next = prompt("Rename timer:", t.name);
    if (next === null) return;
    const v = next.trim();
    if (!v) return;
    t.name = v;
    save();
    render();
  }

  function setTime(t){
    const input = prompt("Set time (mm:ss or h:mm:ss). Examples: 12:30  or  1:05:00", format(t.remainingMs));
    if (input === null) return;
    const v = input.trim();
    if (!v) return;

    const parts = v.split(":").map(x => x.trim());
    if (parts.some(p => p === "" || isNaN(+p))) return;

    let sec = 0;
    if (parts.length === 2){
      sec = (+parts[0]*60) + (+parts[1]);
    } else if (parts.length === 3){
      sec = (+parts[0]*3600) + (+parts[1]*60) + (+parts[2]);
    } else return;

    sec = Math.max(0, Math.floor(sec));
    const wasRunning = t.running;
    setRunning(t, false);
    t.done = false;
    t.totalMs = Math.max(t.totalMs, sec*1000);
    t.remainingMs = sec*1000;
    if (wasRunning && t.remainingMs > 0) setRunning(t, true);
    save();
    render();
  }

  // ---- Render ----
  function cardHtml(t){
    const rem = computeRemaining(t);
    const running = t.running && !t.done;
    const done = t.done || rem <= 0;

    const badge =
      done ? `<span class="badge done">Finished</span>` :
      running ? `<span class="badge running">Running</span>` :
      `<span class="badge">Paused</span>`;

    const pct = t.totalMs > 0 ? clamp(1 - (rem / t.totalMs), 0, 1) : 0;
    const bar = `
      <div style="height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:rgba(10,12,15,.35)">
        <div style="height:100%;width:${Math.round(pct*100)}%;background:rgba(74,163,255,.45)"></div>
      </div>`;

    return `
      <div class="card" data-id="${t.id}">
        <div class="titleRow">
          <div>
            <div class="name">${escapeHtml(t.name)}</div>
            <div class="meta">${badge}</div>
          </div>
          <div class="row">
            <button class="smallBtn" data-act="rename">Rename</button>
            <button class="smallBtn danger" data-act="remove">Remove</button>
          </div>
        </div>

        <div class="time" role="button" title="Click to set time" data-act="settime">${format(rem)}</div>
        ${bar}

        <div class="row">
          <button class="smallBtn primary" data-act="toggle">${running ? "Pause" : "Start"}</button>
          <button class="smallBtn" data-act="reset">Reset</button>
          <button class="smallBtn" data-act="test">Test sound</button>
        </div>

        <div class="row">
          <button class="smallBtn" data-act="m1">+1m</button>
          <button class="smallBtn" data-act="m5">+5m</button>
          <button class="smallBtn" data-act="s30">+30s</button>
          <button class="smallBtn" data-act="sub30">-30s</button>
        </div>

        <div class="hint">
          Tip: tap the big time to set an exact value.
        </div>
      </div>
    `;
  }

  function escapeHtml(s){
    return (s+"").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function render(){
    if (!timers.length){
      grid.innerHTML = `
        <div class="card" style="grid-column:1/-1">
          <div class="name">No timers yet</div>
          <div class="hint">Add a timer at the top (Pizza / Oven / Work etc). You can run multiple at once.</div>
        </div>`;
      return;
    }
    grid.innerHTML = timers.map(cardHtml).join("");
  }

  grid.addEventListener("click", (e) => {
    const card = e.target.closest(".card");
    if (!card) return;
    const id = card.getAttribute("data-id");
    const t = timers.find(x => x.id === id);
    if (!t) return;

    const actEl = e.target.closest("[data-act]");
    if (!actEl) return;
    const act = actEl.getAttribute("data-act");

    if (act === "toggle"){
      userGesture();
      if (t.done) return;
      setRunning(t, !t.running);
      save(); render();
    } else if (act === "reset"){
      reset(t);
    } else if (act === "remove"){
      if (!confirm("Remove this timer?")) return;
      removeTimer(t.id);
    } else if (act === "rename"){
      renameTimer(t);
    } else if (act === "settime"){
      setTime(t);
    } else if (act === "test"){
      userGesture(); playCustomOrBeep();
    } else if (act === "m1"){
      bump(t, 60*1000);
    } else if (act === "m5"){
      bump(t, 5*60*1000);
    } else if (act === "s30"){
      bump(t, 30*1000);
    } else if (act === "sub30"){
      bump(t, -30*1000);
    }
  });

  // Also allow clicking the big time display to set time
  grid.addEventListener("click", (e) => {
    const timeEl = e.target.closest(".time");
    if (!timeEl) return;
    const card = e.target.closest(".card");
    if (!card) return;
    const id = card.getAttribute("data-id");
    const t = timers.find(x => x.id === id);
    if (!t) return;
    setTime(t);
  });

  // ---- Ticker loop ----
  function tick(){
    let changed = false;
    const now = Date.now();

    for (const t of timers){
      if (t.running && !t.done && t.endsAtEpochMs){
        const rem = t.endsAtEpochMs - now;
        if (rem <= 0){
          finishTimer(t);
          changed = true;
        }
      }
    }
    // We render every tick for smoothness (1s), but only save when needed.
    render();
    if (changed) save();
  }

  // keep ticking once per second
  setInterval(tick, 1000);

  // initial render
  render();
})();
</script>

<!-- Matomo -->
<script>
  (function() {
    if (/github\.io$/i.test(window.location.hostname)) {
      return;
    }
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  })();
</script>
<!-- End Matomo Code -->

</body>
</html>
