<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warzone 2100 Autohoster — Games</title>
  <link rel="stylesheet" href="./css/style.css" />

  <style>
    /* Hide the Research column (same as games.html) */
    table[aria-label="Games"] thead th:nth-child(5),
    table[aria-label="Games"] tbody td:nth-child(5){
      display:none !important;
    }

    /* Facet pills */
    /* Hide mode pills completely (labs compact) */
    .facetBlock{display:none !important;}
    #modePills{display:none !important;}

    .facetBlock{margin-top:12px}
    .facetLabel{font-size:12px;color:var(--muted);font-weight:800;margin:10px 0 6px}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .pillbtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#f9fafb;
      border-radius:999px;
      padding:7px 11px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .pillbtn:hover{background:#eef2f7}
    .pillbtn.active{background:var(--accent);border-color:var(--accent);color:#fff}
    .pillbtn.active .count{color:rgba(255,255,255,.85)}
    .pillbtn .count{font-size:12px;color:var(--muted);font-weight:900}

    /* Map gallery */
    .galleryCard{margin-top:14px}
    .galleryHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .galleryTitle{margin:0;font-size:18px}
    .gallerySub{font-size:12px;margin-top:3px;color:var(--muted)}

    .galleryGrid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(160px, 1fr));
      gap:10px;
      padding:12px;
    }
    .mapcard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:#fff;
      cursor:pointer;
      min-width:0;
    }
    .mapcard:hover{background:#f9fafb}
    .mapcard.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,.15) inset}
    .mapname{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mapmeta{margin-top:6px;display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
    .maptag{display:inline-flex;align-items:center;gap:6px}

    /* Grouped list (option 5) */
    #groupWrap{display:flex;flex-direction:column;gap:10px}
    .groupdetails{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:#fff;
      overflow:hidden;
    }
    .groupdetails summary{
      list-style:none;
      cursor:pointer;
      padding:12px 14px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
    }
    .groupdetails summary::-webkit-details-marker{display:none}
    .groupsub{font-size:12px;color:var(--muted);font-weight:800}
    .groupmeta{font-size:12px;color:var(--muted);font-weight:800;white-space:nowrap}

    /* Make hex + replay styling apply in grouped tables too */
    .gamesBody td:first-child a{
      width:40px;
      height:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      clip-path: polygon(25% 5%, 75% 5%, 98% 50%, 75% 95%, 25% 95%, 2% 50%);
      background:#28a745;
      border:1px solid #1f7a34;
      color:transparent;
      text-decoration:none;
      position:relative;
    }
    .gamesBody td:first-child a::after{content:"⚛";color:#fff;font-size:16px;line-height:1;font-weight:700}

    
    /* Clickable research hex affordance */
    .gamesBody td:first-child a{
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .gamesBody td:first-child a:hover{
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,.16);
      filter: brightness(1.05);
    }
    .gamesBody td:first-child a:focus-visible{
      outline: 3px solid rgba(37,99,235,.35);
      outline-offset: 3px;
    }
    .gamesBody td:first-child a::before{
      content:"Research";
      position:absolute;
      left:50%;
      top:-30px;
      transform: translateX(-50%) translateY(2px);
      background:#111827;
      color:#fff;
      padding:4px 8px;
      border-radius:10px;
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
      transition: opacity .12s ease, transform .12s ease;
    }
    .gamesBody td:first-child a:hover::before{
      opacity:1;
      transform: translateX(-50%) translateY(0px);
    }
.gamesBody td:last-child{min-width:130px;width:130px}
    .gamesBody td:last-child a{
      display:inline-block;
      padding:5px 10px;
      font-size:13px;
      line-height:1.1;
      font-weight:600;
      white-space:nowrap;
      border-radius:8px;
      background:#eef1f5;
      border:1px solid #d0d7de;
      color:#111827;
      text-decoration:none;
    }
    .gamesBody td:last-child a:hover{background:#e5e7eb}

    /* Keep the tools row tidy */
    .tools .btn.subtle{padding:10px 12px}
  
    /* --- Labs-only compact top spacing (non-destructive overrides) --- */
    .pagehead{padding-top:18px;padding-bottom:10px}
    .pagehead h1{font-size:40px;line-height:1.05;margin:0 0 6px}
    .pagehead p{margin:0 0 10px;font-size:14px}
    .tools{gap:8px;row-gap:8px}
    .tools .input,.tools .select{padding:8px 10px;min-height:38px}
    .tools .btn{padding:8px 12px;min-height:38px}
    .tools .btn.subtle{padding:8px 10px;min-height:38px}

    .facetBlock{margin-top:8px}
    .facetLabel{margin:6px 0 4px}
    .pillbtn{padding:6px 10px}
    .pillbtn .count{padding:1px 7px}

    .galleryCard{margin-top:10px}
    .galleryHead{padding:12px 14px}
    .galleryGrid{gap:10px;padding:10px}
    .mapmeta{margin-top:4px}

    @media (max-width: 900px){
      .pagehead h1{font-size:34px}
      .tools .input,.tools .select,.tools .btn,.tools .btn.subtle{min-height:36px}
    }

    .hint-small{font-size:15px;color:#6b7280;margin:6px 2px 10px;font-weight:500;}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">Warzone 2100 Autohoster</div>
  <nav class="nav">
    <a class="navlink" data-nav="home" href="./">Home</a>
    <a class="navlink" data-nav="games" href="./games.html">Games</a>
    <a class="navlink" data-nav="players" href="./players.html">Players</a>
    <a class="navlink" data-nav="lobby" href="./lobby.html">Lobby</a>
    <a class="navlink" data-nav="leaderboard" href="./top.html">Leaderboard</a>
  </nav>
</header>

<main class="wrap">
  <section class="pagehead">
<div class="tools">
      <input id="q" type="hidden" value="" />
      <select id="days" class="select" title="Time range">
        <option value="all" selected>All</option>
        <option value="1">24h</option>
        <option value="7">7d</option>
        <option value="30">30d</option>
      </select>
      <select id="limit" class="select" title="Rows">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
        <option value="250">250</option>
      </select>
      <select id="sort" class="select" title="Sort">
        <option value="when" selected>When</option>
        <option value="duration">Duration</option>
        <option value="map">Map</option>
        <option value="result">Result</option>
      </select>
      <button id="dir" class="btn subtle" type="button" title="Toggle sort direction">↓</button>
      <input id="hideMM" type="hidden" />
      <input id="groupByMap" type="hidden" />
<button id="refresh" class="btn">Refresh</button>
      <span id="status" class="status">Idle</span>
    </div>
    <div class="hint-small"><b>Click the green hex for research.</b></div>


    <div class="facetBlock">
<div id="modePills" class="pillbar" aria-label="Mode pills" hidden></div>
    </div>
  </section>

  <section class="card galleryCard" aria-label="Map gallery">
    <!-- Header removed (requested). Keep a hidden Clear Map control for JS wiring. -->
    <button id="clearMap" class="btn subtle" type="button" hidden>Clear map</button>
    <div id="mapGallery" class="galleryGrid"></div>
  </section>

  <section class="layout">
    <section class="card" id="listCard">
      <table class="table" aria-label="Games">
        <thead>
          <tr>
            <th>Game</th>
            <th>Map</th>
            <th>When (UTC)</th>
            <th>Duration</th>
            <th>Research</th>
            <th>Result</th>
            <th>Replay</th>
          </tr>
        </thead>
        <tbody id="gamesBody" class="gamesBody"></tbody>
      </table>
      <div class="footer" id="countLine"></div>

      <div id="groupWrap" hidden style="padding:12px"></div>
    </section>

    <aside class="side" id="detailCard" hidden>
      <div class="detailhead">
        <h2 id="detailTitle">Game</h2>
        <div class="muted" id="detailMeta"></div>
        <div id="detailPills"></div>
      </div>

      <div class="section"><div id="detailReplay"></div></div>

      <div class="section">
        <h3>Players</h3>
        <table class="table small" aria-label="Players">
          <thead>
            <tr>
              <th>Player</th>
              <th>Team</th>
              <th>Outcome</th>
            </tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>

      <div class="section" id="researchSection" hidden>
        <!-- intentionally hidden in this UI -->
        <div id="researchSummary"></div>
        <div id="researchBody"></div>
      </div>

      <div class="section">
        <div class="detailActions">
          <button class="btn subtle" id="copyLink" type="button">Copy link</button>
          <button class="btn subtle" id="closeDetail" type="button">Close</button>
        </div>
      </div>
    </aside>
  </section>
</main>

<script type="module">
/**
 * Compatibility + history loader shim.
 *
 * Your backend now shards match history:
 *   /jsons/matchstats.json              (recent window)
 *   /jsons/matchstats_manifest.json     (lists shard files)
 *   /jsons/matchstats/YYYY-MM.json      (archives)
 *
 * The existing UI only fetches /jsons/matchstats.json.
 * This shim intercepts that fetch and returns the merged history
 * (recent + all shards) while also normalizing fields so the UI
 * continues to display duration/result/replay correctly.
 */
(() => {
  const origFetch = window.fetch.bind(window);

  const isAbort = (e) => e && (e.name === "AbortError" || e.code === 20);

  async function origFetchJson(url, init) {
    const res = await origFetch(url, init);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  function joinUrl(base, rel) {
    try { return new URL(rel, base).toString(); } catch { return (base + rel).replace(/([^:]\/\/)|\/\/+/g, "$1/"); }
  }

  function toLegacyMatch(m) {
    // If already legacy-shaped, keep as-is (but fill small gaps).
    const out = (m && typeof m === "object") ? { ...m } : {};

    // started_utc / ended_utc
    const started = out.started_utc || out.startedAtUtc || out.startedAt || out.start_utc || out.startUtc || "";
    if (started) out.started_utc = String(started);

    // duration
    const ds = (out.duration_s ?? out.durationSec ?? out.duration ?? out.duration_sec ?? out.durationSeconds);
    const dsn = Number(ds);
    if (!Number.isNaN(dsn) && Number.isFinite(dsn)) out.duration_s = dsn;

    if (!out.ended_utc && out.started_utc && out.duration_s) {
      // best-effort ended_utc = started + duration
      const t = Date.parse(out.started_utc);
      if (!Number.isNaN(t)) {
        out.ended_utc = new Date(t + out.duration_s * 1000).toISOString();
      }
    }

    // map name
    if (!out.map) {
      const map = out.mapName || out.map_name || out.game?.map || out.game?.mapName || "";
      if (map) out.map = String(map);
    }

    // replay
    if (!out.replay_url) {
      const ru = out.replayUrl || out.replay || "";
      if (typeof ru === "string" && ru) {
        out.replay_url = ru.startsWith("/") ? ru : `/replays/${ru}`;
      }
    }
    if (!out.replay_file) {
      const rf = out.replayFile || out.replay_filename || out.replayFilename || out.replay;
      if (typeof rf === "string" && rf.endsWith(".wzrp")) out.replay_file = rf;
    }

    // winners/losers
    const hasW = Array.isArray(out.winners) || Array.isArray(out.winner) || Array.isArray(out.won) ||
                 Array.isArray(out.winning_players) || Array.isArray(out.winningPlayers);
    const hasL = Array.isArray(out.losers) || Array.isArray(out.loser) || Array.isArray(out.lost) ||
                 Array.isArray(out.losing_players) || Array.isArray(out.losingPlayers);

    if (!hasW || !hasL) {
      const ps = Array.isArray(out.players) ? out.players : (Array.isArray(out.playerData) ? out.playerData : []);
      const winners = [];
      const losers = [];
      for (const p of ps) {
        const name = (typeof p === "string") ? p : (p?.name ?? p?.player ?? p?.nick ?? "");
        const wl = String(p?.winLoss ?? p?.win_loss ?? "").toLowerCase();
        const isW = Boolean(p?.isWinner) || wl === "win" || wl === "won" || wl === "winner";
        const isL = wl === "loss" || wl === "lost" || wl === "loser";
        if (name) {
          if (isW) winners.push(name);
          else if (isL) losers.push(name);
        }
      }
      if (!out.winners && winners.length) out.winners = winners;
      if (!out.losers && losers.length) out.losers = losers;
    }

    return out;
  }

  async function buildMergedMatchstats(matchstatsUrl, init) {
    const base = matchstatsUrl.replace(/matchstats\.json(\?.*)?$/i, "");
    const manifestUrl = base + "matchstats_manifest.json";

    // Always include the "recent" file in case manifest/shards aren't reachable.
    const items = new Map();

    const addAll = (arr) => {
      if (!Array.isArray(arr)) return;
      for (const m of arr) {
        if (!m || typeof m !== "object") continue;
        const id = m.id || m.legacy_id || m.legacyId || "";
        const key = String(id || JSON.stringify(m));
        if (!items.has(key)) items.set(key, toLegacyMatch(m));
      }
    };

    try {
      addAll(await origFetchJson(matchstatsUrl, init));
    } catch (e) {
      if (isAbort(e)) throw e;
      // continue
    }

    // Load shards from manifest (best-effort).
    try {
      const man = await origFetchJson(manifestUrl, init);
      const shards = Array.isArray(man?.shards) ? man.shards : [];
      for (const s of shards) {
        const rel = s?.file;
        if (!rel) continue;
        const shardUrl = joinUrl(base, rel);
        try {
          addAll(await origFetchJson(shardUrl, init));
        } catch (e) {
          if (isAbort(e)) throw e;
        }
      }
    } catch (e) {
      if (isAbort(e)) throw e;
    }

    // Sort by started_utc desc for nicer default view
    const out = Array.from(items.values());
    out.sort((a, b) => String(b?.started_utc || "").localeCompare(String(a?.started_utc || "")));
    return out;
  }

  window.fetch = async (input, init = {}) => {
    const url = (typeof input === "string") ? input : (input?.url || "");
    // Only intercept the matches list request.
    if (typeof url === "string" && url.includes("/jsons/matchstats.json")) {
      if (init?.signal?.aborted) throw new DOMException("Aborted", "AbortError");
      const merged = await buildMergedMatchstats(url, init);
      return new Response(JSON.stringify(merged), {
        status: 200,
        headers: { "Content-Type": "application/json" },
      });
    }
    return origFetch(input, init);
  };
})();
</script>

<script src="./js/games-labs.js" type="module"></script>
  <script src="./js/nav-active.js"></script>

<!-- Matomo -->
<script>
  (function() {
    if (/github\.io$/i.test(window.location.hostname)) {
      return;
    }
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  })();
</script>
<!-- End Matomo Code -->

</body>
</html>
